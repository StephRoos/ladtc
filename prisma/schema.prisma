// Prisma schema for LADTC
// BetterAuth requires specific table structures (user, session, account, verification)

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  MEMBER
  COACH
  COMMITTEE
  ADMIN
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  emailVerified Boolean       @default(false)
  name          String?
  image         String?
  role          UserRole      @default(MEMBER)
  committeeRole String?       @db.VarChar(100)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  sessions      Session[]
  accounts      Account[]
  membership    Membership?
  orders        Order[]
  activityLogs  ActivityLog[]
  blogPosts     BlogPost[]
  eventRegistrations EventRegistration[]
  galleryPhotos GalleryPhoto[]
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String
  target    String?
  targetId  String?
  changes   Json?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Membership {
  id                    String           @id @default(cuid())
  userId                String           @unique
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  status                MembershipStatus @default(PENDING)
  joinedAt              DateTime         @default(now())
  renewalDate           DateTime
  paidAt                DateTime?
  amount                Float            @default(50.0)
  phone                 String?
  emergencyContact      String?
  emergencyContactPhone String?
  notes                 String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@index([status])
  @@index([renewalDate])
}

enum MembershipStatus {
  PENDING
  ACTIVE
  INACTIVE
  EXPIRED
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

model Product {
  id          String      @id @default(cuid())
  name        String
  description String?
  price       Float
  image       String?
  sizes       String[]
  stock       Int
  sku         String?     @unique
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  orderItems  OrderItem[]

  @@index([active])
}

model Order {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  shippingName    String
  shippingEmail   String
  shippingPhone   String
  shippingAddress String
  shippingCity    String
  shippingZip     String
  shippingCountry String      @default("Belgium")

  items           OrderItem[]
  subtotal        Float
  shippingCost    Float       @default(0.0)
  tax             Float       @default(0.0)
  total           Float

  status          OrderStatus @default(PENDING)
  notes           String?

  trackingNumber  String?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id])

  quantity  Int
  size      String?
  price     Float

  @@unique([orderId, productId, size])
}

enum EventType {
  TRAINING
  RACE
  CAMP
  SOCIAL
}

enum RegistrationStatus {
  REGISTERED
  ATTENDED
  CANCELLED
}

model Event {
  id              String              @id @default(cuid())
  title           String
  description     String?
  date            DateTime
  endDate         DateTime?
  image           String?
  location        String
  type            EventType
  difficulty      String?
  maxParticipants Int?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  registrations   EventRegistration[]

  @@index([date])
  @@index([type])
}

model EventRegistration {
  id        String             @id @default(cuid())
  userId    String
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId   String
  event     Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  status    RegistrationStatus @default(REGISTERED)
  createdAt DateTime           @default(now())

  @@unique([userId, eventId])
  @@index([eventId])
  @@index([userId])
}

model BlogPost {
  id               String    @id @default(cuid())
  title            String
  slug             String    @unique
  content          String
  excerpt          String?
  featuredImageUrl String?
  authorId         String
  author           User      @relation(fields: [authorId], references: [id])
  category         String?
  tags             String[]
  published        Boolean   @default(false)
  publishedAt      DateTime?
  eventDate        DateTime?
  eventLocation    String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([published, publishedAt(sort: Desc)])
  @@index([eventDate])
}

model GalleryPhoto {
  id           String   @id @default(cuid())
  url          String
  title        String
  description  String?
  category     String?
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([category])
  @@index([createdAt])
}
